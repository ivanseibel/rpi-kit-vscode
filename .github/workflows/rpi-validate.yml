name: Validate RPI Artifacts

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  validate-rpi-artifacts:
    name: Validate RPI Workflow Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate global instruction file
        run: |
          echo "Checking .github/copilot-instructions.md..."
          test -f .github/copilot-instructions.md || { echo "‚ùå Missing global instruction file"; exit 1; }
          grep -q "RPI constitution" .github/copilot-instructions.md || { echo "‚ùå Missing RPI constitution phrase"; exit 1; }
          if grep -q "applyTo:" .github/copilot-instructions.md; then
            echo "‚ùå Global instruction file should not contain applyTo"
            exit 1
          fi
          echo "‚úÖ Global instruction file valid"

      - name: Validate governance files
        run: |
          echo "Checking AGENTS.md files..."
          test -f AGENTS.md || { echo "‚ùå Missing root AGENTS.md"; exit 1; }
          test -f .rpi/AGENTS.md || { echo "‚ùå Missing .rpi/AGENTS.md"; exit 1; }

          # Check for required table with role names
          grep -q "Researcher" AGENTS.md || { echo "‚ùå Missing Researcher role"; exit 1; }
          grep -q "Planner" AGENTS.md || { echo "‚ùå Missing Planner role"; exit 1; }
          grep -q "Implementer" AGENTS.md || { echo "‚ùå Missing Implementer role"; exit 1; }

          # Verify files are identical
          diff AGENTS.md .rpi/AGENTS.md || { echo "‚ùå AGENTS.md files not identical"; exit 1; }
          echo "‚úÖ Governance files valid"

      - name: Validate scoped instruction files
        run: |
          echo "Checking scoped instruction files..."
          test -d .github/instructions || { echo "‚ùå Missing instructions directory"; exit 1; }

          # Research instructions
          test -f .github/instructions/research.instructions.md || { echo "‚ùå Missing research.instructions.md"; exit 1; }
          grep -q "^---" .github/instructions/research.instructions.md || { echo "‚ùå Missing frontmatter delimiter"; exit 1; }
          grep -q "applyTo:" .github/instructions/research.instructions.md || { echo "‚ùå Missing applyTo field"; exit 1; }
          grep -q "description:" .github/instructions/research.instructions.md || { echo "‚ùå Missing description field"; exit 1; }
          grep -q "Must:" .github/instructions/research.instructions.md || { echo "‚ùå Missing Must: constraint"; exit 1; }

          # Plan instructions
          test -f .github/instructions/plan.instructions.md || { echo "‚ùå Missing plan.instructions.md"; exit 1; }
          grep -q "^---" .github/instructions/plan.instructions.md || { echo "‚ùå Missing frontmatter delimiter"; exit 1; }
          grep -q "applyTo:" .github/instructions/plan.instructions.md || { echo "‚ùå Missing applyTo field"; exit 1; }
          grep -q "description:" .github/instructions/plan.instructions.md || { echo "‚ùå Missing description field"; exit 1; }
          grep -q "Must:" .github/instructions/plan.instructions.md || { echo "‚ùå Missing Must: constraint"; exit 1; }

          echo "‚úÖ Scoped instruction files valid"

      - name: Validate RPI workflow skill
        run: |
          echo "Checking RPI workflow skill..."
          test -d .github/skills/rpi-workflow || { echo "‚ùå Missing skill directory"; exit 1; }
          test -f .github/skills/rpi-workflow/SKILL.md || { echo "‚ùå Missing SKILL.md"; exit 1; }

          # Check frontmatter
          grep -q "^---" .github/skills/rpi-workflow/SKILL.md || { echo "‚ùå Missing frontmatter delimiter"; exit 1; }
          grep -q "^name: " .github/skills/rpi-workflow/SKILL.md || { echo "‚ùå Missing name field"; exit 1; }
          grep -q "^description: " .github/skills/rpi-workflow/SKILL.md || { echo "‚ùå Missing description field"; exit 1; }

          # Check name format (lowercase, hyphens only)
          SKILL_NAME=$(grep "^name: " .github/skills/rpi-workflow/SKILL.md | sed 's/^name: //')
          if ! echo "$SKILL_NAME" | grep -qE "^[a-z0-9-]+$"; then
            echo "‚ùå Skill name must match ^[a-z0-9-]+$ regex"
            exit 1
          fi

          # Check required sections
          grep -q "^## Usage" .github/skills/rpi-workflow/SKILL.md || { echo "‚ùå Missing Usage section"; exit 1; }
          grep -q "^## Resources" .github/skills/rpi-workflow/SKILL.md || { echo "‚ùå Missing Resources section"; exit 1; }

          # Check resources
          test -f .github/skills/rpi-workflow/resources/plan-template.md || { echo "‚ùå Missing plan-template.md"; exit 1; }
          test -f .github/skills/rpi-workflow/resources/prompts/plan-example.md || { echo "‚ùå Missing plan-example.md"; exit 1; }
          test -f .github/skills/rpi-workflow/resources/validation/README.md || { echo "‚ùå Missing validation README.md"; exit 1; }

          echo "‚úÖ RPI workflow skill valid"

      - name: Validate prompt entry points
        run: |
          echo "Checking prompt files..."
          test -d .github/prompts || { echo "‚ùå Missing prompts directory"; exit 1; }

          # rpikit.research prompt
          test -f .github/prompts/rpikit.research.prompt.md || { echo "‚ùå Missing rpikit.research.prompt.md"; exit 1; }
          grep -q "Input:" .github/prompts/rpikit.research.prompt.md || { echo "‚ùå Missing Input: line in rpikit.research prompt"; exit 1; }

          # rpikit.plan prompt
          test -f .github/prompts/rpikit.plan.prompt.md || { echo "‚ùå Missing rpikit.plan.prompt.md"; exit 1; }
          grep -q "Input:" .github/prompts/rpikit.plan.prompt.md || { echo "‚ùå Missing Input: line in rpikit.plan prompt"; exit 1; }

          # rpikit.implement prompt
          test -f .github/prompts/rpikit.implement.prompt.md || { echo "‚ùå Missing rpikit.implement.prompt.md"; exit 1; }
          grep -q "Input:" .github/prompts/rpikit.implement.prompt.md || { echo "‚ùå Missing Input: line in rpikit.implement prompt"; exit 1; }

          echo "‚úÖ Prompt entry points valid"

      - name: Validate VS Code settings and documentation
        run: |
          echo "Checking VS Code settings..."
          test -f .vscode/settings.json || { echo "‚ùå Missing .vscode/settings.json"; exit 1; }
          grep -q "github.copilot.chat.codeGeneration.useInstructionFiles" .vscode/settings.json || { echo "‚ùå Missing useInstructionFiles setting"; exit 1; }

          echo "Checking documentation..."
          test -f .rpi/docs/rpi-workflow.md || { echo "‚ùå Missing rpi-workflow.md"; exit 1; }
          grep -q "VS Code Load Checks" .rpi/docs/rpi-workflow.md || { echo "‚ùå Missing VS Code Load Checks section"; exit 1; }

          echo "‚úÖ Settings and documentation valid"

      - name: Validate helper script
        run: |
          echo "Checking helper script..."
          test -f .rpi/scripts/check-vscode-load.sh || { echo "‚ùå Missing check-vscode-load.sh"; exit 1; }
          test -x .rpi/scripts/check-vscode-load.sh || { echo "‚ùå Script not executable"; exit 1; }

          # Check that script contains required steps
          grep -q "Step 1:" .rpi/scripts/check-vscode-load.sh || { echo "‚ùå Missing Step 1 in script"; exit 1; }
          grep -q "Step 2:" .rpi/scripts/check-vscode-load.sh || { echo "‚ùå Missing Step 2 in script"; exit 1; }
          grep -q "Step 3:" .rpi/scripts/check-vscode-load.sh || { echo "‚ùå Missing Step 3 in script"; exit 1; }

          echo "‚úÖ Helper script valid"

      - name: Validate handoff checklist
        run: |
          echo "Checking handoff checklist..."
          test -f .rpi/docs/handoff-checklist.md || { echo "‚ùå Missing handoff-checklist.md"; exit 1; }

          # Check for required checklist items
          grep -q "research.md validated" .rpi/docs/handoff-checklist.md || { echo "‚ùå Missing research.md validated item"; exit 1; }
          grep -q "plan.md present and FACTS affirmed" .rpi/docs/handoff-checklist.md || { echo "‚ùå Missing plan.md FACTS item"; exit 1; }
          grep -q "AGENTS.md reviewed" .rpi/docs/handoff-checklist.md || { echo "‚ùå Missing AGENTS.md reviewed item"; exit 1; }
          grep -q "CI validation passing" .rpi/docs/handoff-checklist.md || { echo "‚ùå Missing CI validation item"; exit 1; }
          grep -q "SIGNOFF" .rpi/docs/handoff-checklist.md || { echo "‚ùå Missing SIGNOFF documentation"; exit 1; }

          echo "‚úÖ Handoff checklist valid"

      - name: Validate RPI phase artifacts (if present)
        run: |
          echo "Checking for RPI phase artifacts..."

          # Find all .rpi project directories
          if [ -d .rpi ]; then
            for PROJECT_DIR in .rpi/projects/*/; do
              if [ -d "$PROJECT_DIR" ]; then
                PROJECT_NAME=$(basename "$PROJECT_DIR")
                echo "Checking project: $PROJECT_NAME"
                
                # If research.md exists, validate structure
                if [ -f "${PROJECT_DIR}research.md" ]; then
                  echo "  Validating research.md..."
                  grep -q "Problem Statement" "${PROJECT_DIR}research.md" || echo "  ‚ö†Ô∏è  Missing Problem Statement section"
                  grep -q "FAR" "${PROJECT_DIR}research.md" || echo "  ‚ö†Ô∏è  Missing FAR validation"
                fi
                
                # If plan.md exists, validate structure
                if [ -f "${PROJECT_DIR}plan.md" ]; then
                  echo "  Validating plan.md..."
                  grep -q "FACTS" "${PROJECT_DIR}plan.md" || echo "  ‚ö†Ô∏è  Missing FACTS validation"
                  grep -q "Atomic Task List" "${PROJECT_DIR}plan.md" || echo "  ‚ö†Ô∏è  Missing Atomic Task List section"
                fi
              fi
            done
          fi

          echo "‚úÖ Phase artifacts checked"

      - name: Validate RPI project naming
        run: |
          echo "Checking .rpi project naming..."

          if [ -d .rpi ]; then
            LEGACY_ALLOWLIST="email-service rpi-framework-improvements"

            for PROJECT_DIR in .rpi/projects/*/; do
              if [ -d "$PROJECT_DIR" ]; then
                PROJECT_NAME=$(basename "$PROJECT_DIR")

                if [ -f "${PROJECT_DIR}research.md" ] || [ -f "${PROJECT_DIR}plan.md" ]; then
                  if echo "$PROJECT_NAME" | grep -qE "^[0-9]{4}-"; then
                    continue
                  fi

                  if echo "$LEGACY_ALLOWLIST" | grep -qw "$PROJECT_NAME"; then
                    echo "  Legacy project allowed: $PROJECT_NAME"
                    continue
                  fi

                  echo "‚ùå RPI project directory must be prefixed with NNNN- (got: $PROJECT_NAME)"
                  exit 1
                fi
              fi
            done
          fi

          echo "‚úÖ .rpi naming valid"

      - name: Check for SIGNOFF on implementation PRs
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking for implementation labels and SIGNOFF..."

          # Note: This is a simplified check. In production, you would:
          # 1. Use GitHub API to check PR labels
          # 2. Verify SIGNOFF file exists if "implementation" label is present
          # 3. Ensure all tasks in plan.md are marked complete

          # For now, just check if any SIGNOFF files exist in changed files
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "SIGNOFF"; then
            echo "‚úÖ SIGNOFF file detected in PR"
          else
            echo "‚ÑπÔ∏è  No SIGNOFF file in this PR (OK if not implementation phase)"
          fi

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "‚úÖ All RPI workflow artifacts validated!"
          echo "=========================================="
          echo ""
          echo "Validated:"
          echo "  ‚Ä¢ Global instruction file"
          echo "  ‚Ä¢ Governance files (AGENTS.md)"
          echo "  ‚Ä¢ Scoped instruction files"
          echo "  ‚Ä¢ RPI workflow skill"
          echo "  ‚Ä¢ Prompt entry points"
          echo "  ‚Ä¢ VS Code settings and docs"
          echo "  ‚Ä¢ Helper script"
          echo "  ‚Ä¢ Handoff checklist"
          echo "  ‚Ä¢ Phase artifacts (if present)"
          echo ""
          echo "Repository is RPI-compliant! üéâ"
